<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Evaluate an expression with quosures and pronoun support — eval_tidy • rlang</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Evaluate an expression with quosures and pronoun support — eval_tidy" />
<meta property="og:description" content="
eval_tidy() is a variant of base::eval() that powers the tidy
evaluation framework. Like eval() it accepts user data as
argument. Whereas eval() simply transforms the data to an
environment, eval_tidy() transforms it to a data mask with
as_data_mask(). Evaluating in a data mask enables the following
features:
Quosures. Quosures are expressions bundled with an
environment. If data is supplied, objects in the data mask
always have precedence over the quosure environment, i.e. the
data masks the environment.
Pronouns. If data is supplied, the .env and .data
pronouns are installed in the data mask. .env is a reference to
the calling environment and .data refers to the data argument.
These pronouns lets you be explicit about where to find
values and throw errors if you try to access non-existent values.

" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rlang</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.8.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../reference/lifecycle.html">Life cycle</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/">Version 0.4.3</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/06/rlang-0-4-0/">Version 0.4.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/01/rlang-0-3-1/">Version 0.3.1</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/10/rlang-0-3-0/">Version 0.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/03/rlang-0.2.0/">Version 0.2.0</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/rlang/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Evaluate an expression with quosures and pronoun support</h1>
    <small class="dont-index">Source: <a href='https://github.com/r-lib/rlang/blob/master/R/eval-tidy.R'><code>R/eval-tidy.R</code></a></small>
    <div class="hidden name"><code>eval_tidy.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><a href='https://www.tidyverse.org/lifecycle/#stable'><img src='figures/lifecycle-stable.svg' alt='Stable lifecycle'></a></p>
<p><code>eval_tidy()</code> is a variant of <code><a href='https://rdrr.io/r/base/eval.html'>base::eval()</a></code> that powers the tidy
evaluation framework. Like <code><a href='https://rdrr.io/r/base/eval.html'>eval()</a></code> it accepts user data as
argument. Whereas <code><a href='https://rdrr.io/r/base/eval.html'>eval()</a></code> simply transforms the data to an
environment, <code>eval_tidy()</code> transforms it to a <strong>data mask</strong> with
<code><a href='as_data_mask.html'>as_data_mask()</a></code>. Evaluating in a data mask enables the following
features:</p><ul>
<li><p><a href='nse-defuse.html'>Quosures</a>. Quosures are expressions bundled with an
environment. If <code>data</code> is supplied, objects in the data mask
always have precedence over the quosure environment, i.e. the
data masks the environment.</p></li>
<li><p><a href='tidyeval-data.html'>Pronouns</a>. If <code>data</code> is supplied, the <code>.env</code> and <code>.data</code>
pronouns are installed in the data mask. <code>.env</code> is a reference to
the calling environment and <code>.data</code> refers to the <code>data</code> argument.
These pronouns lets you be explicit about where to find
values and throw errors if you try to access non-existent values.</p></li>
</ul>

    </div>

    <pre class="usage"><span class='fu'>eval_tidy</span><span class='op'>(</span><span class='va'>expr</span>, data <span class='op'>=</span> <span class='cn'>NULL</span>, env <span class='op'>=</span> <span class='fu'><a href='caller_env.html'>caller_env</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>expr</th>
      <td><p>An expression or quosure to evaluate.</p></td>
    </tr>
    <tr>
      <th>data</th>
      <td><p>A data frame, or named list or vector. Alternatively, a
data mask created with <code><a href='as_data_mask.html'>as_data_mask()</a></code> or
<code><a href='as_data_mask.html'>new_data_mask()</a></code>. Objects in <code>data</code> have priority over those in
<code>env</code>. See the section about data masking.</p></td>
    </tr>
    <tr>
      <th>env</th>
      <td><p>The environment in which to evaluate <code>expr</code>. This
environment is not applicable for quosures because they have
their own environments.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="data-masking"><a class="anchor" href="#data-masking"></a>Data masking</h2>

    


<p>Data masking refers to how columns or objects inside <code>data</code> have
priority over objects defined in <code>env</code> (or in the quosure
environment, if applicable). If there is a column <code>var</code> in <code>data</code>
and an object <code>var</code> in <code>env</code>, and <code>expr</code> refers to <code>var</code>, the
column has priority:</p><pre><span class='va'>var</span> <span class='op'>&lt;-</span> <span class='st'>"this one?"</span>
<span class='va'>data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>var <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"Or that one?"</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>within</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>expr</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'>eval_tidy</span><span class='op'>(</span><span class='fu'><a href='nse-defuse.html'>enquo</a></span><span class='op'>(</span><span class='va'>expr</span><span class='op'>)</span>, <span class='va'>data</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'><a href='https://rdrr.io/r/base/with.html'>within</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='fu'><a href='https://rdrr.io/r/base/chartr.html'>toupper</a></span><span class='op'>(</span><span class='va'>var</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>#&gt; [1] "OR THAT ONE?" "OR THAT ONE?" "OR THAT ONE?"</span>
</pre>

<p>Because the columns or objects in <code>data</code> are always found first,
before objects from <code>env</code>, we say that the data "masks" the
environment.</p>
    <h2 class="hasAnchor" id="when-should-eval-tidy-be-used-instead-of-eval-"><a class="anchor" href="#when-should-eval-tidy-be-used-instead-of-eval-"></a>When should eval_tidy() be used instead of eval()?</h2>

    


<p><code><a href='https://rdrr.io/r/base/eval.html'>base::eval()</a></code> is sufficient for simple evaluation. Use
<code>eval_tidy()</code> when you'd like to support expressions referring to
the <code>.data</code> pronoun, or when you need to support quosures.</p>
<p>If you're evaluating an expression captured with quasiquotation
support, it is recommended to use <code>eval_tidy()</code> because users will
likely unquote quosures.</p>
<p>Note that unwrapping a quosure with <code><a href='quosure.html'>quo_get_expr()</a></code> does not
guarantee that there is no quosures inside the expression. Quosures
might be unquoted anywhere. For instance, the following does not
work reliably in the presence of nested quosures:</p><pre><span class='va'>my_quoting_fn</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='nse-defuse.html'>enquo</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>
  <span class='va'>expr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='quosure.html'>quo_get_expr</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>
  <span class='va'>env</span> <span class='op'>&lt;-</span> <span class='fu'><a href='quosure.html'>quo_get_env</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/eval.html'>eval</a></span><span class='op'>(</span><span class='va'>expr</span>, <span class='va'>env</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># Works:</span>
<span class='fu'>my_quoting_fn</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/chartr.html'>toupper</a></span><span class='op'>(</span><span class='va'>letters</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># Fails because of a nested quosure:</span>
<span class='fu'>my_quoting_fn</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/chartr.html'>toupper</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='fu'><a href='nse-defuse.html'>quo</a></span><span class='op'>(</span><span class='va'>letters</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</pre>

    <h2 class="hasAnchor" id="stack-semantics-of-eval-tidy-"><a class="anchor" href="#stack-semantics-of-eval-tidy-"></a>Stack semantics of <code>eval_tidy()</code></h2>

    


<p><code>eval_tidy()</code> has different stack semantics than <code><a href='https://rdrr.io/r/base/eval.html'>base::eval()</a></code>:</p><ul>
<li><p>Functions that require the evaluation environment to correspond
to a frame on the call stack do not work. This is why <code><a href='https://rdrr.io/r/base/function.html'>return()</a></code>
called from a quosure does not work.</p></li>
<li><p>The mask environment creates a new branch in the call tree
defined by <code><a href='https://rdrr.io/r/base/sys.parent.html'>sys.parent()</a></code> (you can visualise it in a <code><a href='https://rdrr.io/r/base/browser.html'>browser()</a></code>
session with <code>lobstr::cst()</code>).</p></li>
</ul>

<p>See also <code><a href='eval_bare.html'>eval_bare()</a></code> for more information about these differences.</p>
    <h2 class="hasAnchor" id="life-cycle"><a class="anchor" href="#life-cycle"></a>Life cycle</h2>

    


<p><strong>rlang 0.3.0</strong></p>
<p>Passing an environment to <code>data</code> is deprecated. Please construct an
rlang data mask with <code><a href='as_data_mask.html'>new_data_mask()</a></code>.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><a href='nse-force.html'>nse-force</a> for the second leg of the tidy evaluation
framework.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'># With simple quoted expressions eval_tidy() works the same way as</span>
<span class='co'># eval():</span>
<span class='va'>apple</span> <span class='op'>&lt;-</span> <span class='st'>"apple"</span>
<span class='va'>kiwi</span> <span class='op'>&lt;-</span> <span class='st'>"kiwi"</span>
<span class='va'>expr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='va'>apple</span>, <span class='va'>kiwi</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>expr</span>
</div><div class='output co'>#&gt; paste(apple, kiwi)</div><div class='input'>
<span class='fu'><a href='https://rdrr.io/r/base/eval.html'>eval</a></span><span class='op'>(</span><span class='va'>expr</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "apple kiwi"</div><div class='input'><span class='fu'>eval_tidy</span><span class='op'>(</span><span class='va'>expr</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "apple kiwi"</div><div class='input'>
<span class='co'># Both accept a data mask as argument:</span>
<span class='va'>data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>apple <span class='op'>=</span> <span class='st'>"CARROT"</span>, kiwi <span class='op'>=</span> <span class='st'>"TOMATO"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/eval.html'>eval</a></span><span class='op'>(</span><span class='va'>expr</span>, <span class='va'>data</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "CARROT TOMATO"</div><div class='input'><span class='fu'>eval_tidy</span><span class='op'>(</span><span class='va'>expr</span>, <span class='va'>data</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "CARROT TOMATO"</div><div class='input'>

<span class='co'># In addition eval_tidy() has support for quosures:</span>
<span class='va'>with_data</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>expr</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>quo</span> <span class='op'>&lt;-</span> <span class='fu'><a href='nse-defuse.html'>enquo</a></span><span class='op'>(</span><span class='va'>expr</span><span class='op'>)</span>
  <span class='fu'>eval_tidy</span><span class='op'>(</span><span class='va'>quo</span>, <span class='va'>data</span><span class='op'>)</span>
<span class='op'>}</span>
<span class='fu'>with_data</span><span class='op'>(</span><span class='cn'>NULL</span>, <span class='va'>apple</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "apple"</div><div class='input'><span class='fu'>with_data</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>apple</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "CARROT"</div><div class='input'><span class='fu'>with_data</span><span class='op'>(</span><span class='va'>data</span>, <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>apple</span>, <span class='va'>kiwi</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [[1]]
#&gt; [1] "CARROT"
#&gt; 
#&gt; [[2]]
#&gt; [1] "TOMATO"
#&gt; </div><div class='input'>
<span class='co'># Secondly eval_tidy() installs handy pronouns that allow users to</span>
<span class='co'># be explicit about where to find symbols:</span>
<span class='fu'>with_data</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>.data</span><span class='op'>$</span><span class='va'>apple</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "CARROT"</div><div class='input'><span class='fu'>with_data</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>.env</span><span class='op'>$</span><span class='va'>apple</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "apple"</div><div class='input'>

<span class='co'># Note that instead of using `.env` it is often equivalent and may</span>
<span class='co'># be preferred to unquote a value. There are two differences. First</span>
<span class='co'># unquoting happens earlier, when the quosure is created. Secondly,</span>
<span class='co'># subsetting `.env` with the `$` operator may be brittle because</span>
<span class='co'># `$` does not look through the parents of the environment.</span>
<span class='co'>#</span>
<span class='co'># For instance using `.env$name` in a magrittr pipeline is an</span>
<span class='co'># instance where this poses problem, because the magrittr pipe</span>
<span class='co'># currently (as of v1.5.0) evaluates its operands in a *child* of</span>
<span class='co'># the current environment (this child environment is where it</span>
<span class='co'># defines the pronoun `.`).</span>
<span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>data</span> <span class='op'>%&gt;%</span> <span class='fu'>with_data</span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='va'>kiwi</span><span class='op'>)</span>     <span class='co'># "kiwi"</span>
  <span class='va'>data</span> <span class='op'>%&gt;%</span> <span class='fu'>with_data</span><span class='op'>(</span><span class='va'>.env</span><span class='op'>$</span><span class='va'>kiwi</span><span class='op'>)</span>  <span class='co'># NULL</span>
<span class='op'>}</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Lionel Henry, <a href='http://hadley.nz'>Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


