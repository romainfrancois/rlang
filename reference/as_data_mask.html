<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create a data mask — as_data_mask • rlang</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Create a data mask — as_data_mask" />
<meta property="og:description" content="
A data mask is an environment (or possibly multiple environments
forming an ancestry) containing user-supplied objects. Objects in
the mask have precedence over objects in the environment (i.e. they
mask those objects). Many R functions evaluate quoted expressions
in a data mask so these expressions can refer to objects within the
user data.
These functions let you construct a tidy eval data mask manually.
They are meant for developers of tidy eval interfaces rather than
for end users." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rlang</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.8.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../reference/lifecycle.html">Life cycle</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/">Version 0.4.3</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/06/rlang-0-4-0/">Version 0.4.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/01/rlang-0-3-1/">Version 0.3.1</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/10/rlang-0-3-0/">Version 0.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/03/rlang-0.2.0/">Version 0.2.0</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/rlang/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a data mask</h1>
    <small class="dont-index">Source: <a href='https://github.com/r-lib/rlang/blob/master/R/eval-tidy.R'><code>R/eval-tidy.R</code></a></small>
    <div class="hidden name"><code>as_data_mask.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><a href='https://www.tidyverse.org/lifecycle/#stable'><img src='figures/lifecycle-stable.svg' alt='Stable lifecycle'></a></p>
<p>A data mask is an environment (or possibly multiple environments
forming an ancestry) containing user-supplied objects. Objects in
the mask have precedence over objects in the environment (i.e. they
mask those objects). Many R functions evaluate quoted expressions
in a data mask so these expressions can refer to objects within the
user data.</p>
<p>These functions let you construct a tidy eval data mask manually.
They are meant for developers of tidy eval interfaces rather than
for end users.</p>
    </div>

    <pre class="usage"><span class='fu'>as_data_mask</span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span>

<span class='fu'>as_data_pronoun</span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span>

<span class='fu'>new_data_mask</span><span class='op'>(</span><span class='va'>bottom</span>, top <span class='op'>=</span> <span class='va'>bottom</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>data</th>
      <td><p>A data frame or named vector of masking data.</p></td>
    </tr>
    <tr>
      <th>bottom</th>
      <td><p>The environment containing masking objects if the
data mask is one environment deep. The bottom environment if the
data mask comprises multiple environment.</p>
<p>If you haven't supplied <code>top</code>, this <strong>must</strong> be an environment
that you own, i.e. that you have created yourself.</p></td>
    </tr>
    <tr>
      <th>top</th>
      <td><p>The last environment of the data mask. If the data mask
is only one environment deep, <code>top</code> should be the same as
<code>bottom</code>.</p>
<p>This <strong>must</strong> be an environment that you own, i.e. that you have
created yourself. The parent of <code>top</code> will be changed by the tidy
eval engine and should be considered undetermined. Never make
assumption about the parent of <code>top</code>.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A data mask that you can supply to <code><a href='eval_tidy.html'>eval_tidy()</a></code>.</p>
    <h2 class="hasAnchor" id="why-build-a-data-mask-"><a class="anchor" href="#why-build-a-data-mask-"></a>Why build a data mask?</h2>

    


<p>Most of the time you can just call <code><a href='eval_tidy.html'>eval_tidy()</a></code> with a list or a
data frame and the data mask will be constructed automatically.
There are three main use cases for manual creation of data masks:</p><ul>
<li><p>When <code><a href='eval_tidy.html'>eval_tidy()</a></code> is called with the same data in a tight loop.
Because there is some overhead to creating tidy eval data masks,
constructing the mask once and reusing it for subsequent
evaluations may improve performance.</p></li>
<li><p>When several expressions should be evaluated in the exact same
environment because a quoted expression might create new objects
that can be referred in other quoted expressions evaluated at a
later time. One example of this is <code><a href='https://tibble.tidyverse.org/reference/lst.html'>tibble::lst()</a></code> where new
columns can refer to previous ones.</p></li>
<li><p>When your data mask requires special features. For instance the
data frame columns in dplyr data masks are implemented with
<a href='https://rdrr.io/r/base/delayedAssign.html'>active bindings</a>.</p></li>
</ul>

    <h2 class="hasAnchor" id="building-your-own-data-mask"><a class="anchor" href="#building-your-own-data-mask"></a>Building your own data mask</h2>

    


<p>Unlike <code><a href='https://rdrr.io/r/base/eval.html'>base::eval()</a></code> which takes any kind of environments as data
mask, <code><a href='eval_tidy.html'>eval_tidy()</a></code> has specific requirements in order to support
<a href='nse-defuse.html'>quosures</a>. For this reason you can't supply bare
environments.</p>
<p>There are two ways of constructing an rlang data mask manually:</p><ul>
<li><p><code>as_data_mask()</code> transforms a list or data frame to a data mask.
It automatically installs the data pronoun <code><a href='tidyeval-data.html'>.data</a></code>.</p></li>
<li><p><code>new_data_mask()</code> is a bare bones data mask constructor for
environments. You can supply a bottom and a top environment in
case your data mask comprises multiple environments (see section
below).</p>
<p>Unlike <code>as_data_mask()</code> it does not install the <code>.data</code> pronoun
so you need to provide one yourself. You can provide a pronoun
constructed with <code>as_data_pronoun()</code> or your own pronoun class.</p>
<p><code>as_data_pronoun()</code> will create a pronoun from a list, an
environment, or an rlang data mask. In the latter case, the whole
ancestry is looked up from the bottom to the top of the mask.
Functions stored in the mask are bypassed by the pronoun.</p></li>
</ul>

<p>Once you have built a data mask, simply pass it to <code><a href='eval_tidy.html'>eval_tidy()</a></code> as
the <code>data</code> argument. You can repeat this as many times as
needed. Note that any objects created there (perhaps because of a
call to <code>&lt;-</code>) will persist in subsequent evaluations.</p>
    <h2 class="hasAnchor" id="top-and-bottom-of-data-mask"><a class="anchor" href="#top-and-bottom-of-data-mask"></a>Top and bottom of data mask</h2>

    


<p>In some cases you'll need several levels in your data mask. One
good reason is when you include functions in the mask. It's a good
idea to keep data objects one level lower than function objects, so
that the former cannot override the definitions of the latter (see
examples).</p>
<p>In that case, set up all your environments and keep track of the
bottom child and the top parent. You'll need to pass both to
<code>new_data_mask()</code>.</p>
<p>Note that the parent of the top environment is completely
undetermined, you shouldn't expect it to remain the same at all
times. This parent is replaced during evaluation by <code><a href='eval_tidy.html'>eval_tidy()</a></code>
to one of the following environments:</p><ul>
<li><p>The default environment passed as the <code>env</code> argument of <code><a href='eval_tidy.html'>eval_tidy()</a></code>.</p></li>
<li><p>The environment of the current quosure being evaluated, if applicable.</p></li>
</ul>

<p>Consequently, all masking data should be contained between the
bottom and top environment of the data mask.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Evaluating in a tidy evaluation environment enables all tidy</span>
<span class='co'># features:</span>
<span class='va'>mask</span> <span class='op'>&lt;-</span> <span class='fu'>as_data_mask</span><span class='op'>(</span><span class='va'>mtcars</span><span class='op'>)</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='nse-defuse.html'>quo</a></span><span class='op'>(</span><span class='va'>letters</span><span class='op'>)</span>, <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt;  [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
#&gt; [20] "t" "u" "v" "w" "x" "y" "z"</div><div class='input'>
<span class='co'># You can install new pronouns in the mask:</span>
<span class='va'>mask</span><span class='op'>$</span><span class='va'>.pronoun</span> <span class='op'>&lt;-</span> <span class='fu'>as_data_pronoun</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>foo <span class='op'>=</span> <span class='st'>"bar"</span>, baz <span class='op'>=</span> <span class='st'>"bam"</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='nse-defuse.html'>quo</a></span><span class='op'>(</span><span class='va'>.pronoun</span><span class='op'>$</span><span class='va'>foo</span><span class='op'>)</span>, <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "bar"</div><div class='input'>
<span class='co'># In some cases the data mask can leak to the user, for example if</span>
<span class='co'># a function or formula is created in the data mask environment:</span>
<span class='va'>cyl</span> <span class='op'>&lt;-</span> <span class='st'>"user variable from the context"</span>
<span class='va'>fn</span> <span class='op'>&lt;-</span> <span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span> <span class='va'>cyl</span><span class='op'>)</span>, <span class='va'>mask</span><span class='op'>)</span>
<span class='fu'>fn</span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt;  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4</div><div class='input'>
<span class='co'># If new objects are created in the mask, they persist in the</span>
<span class='co'># subsequent calls:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='va'>new</span> <span class='op'>&lt;-</span> <span class='va'>cyl</span> <span class='op'>+</span> <span class='va'>am</span><span class='op'>)</span>, <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt;  [1] 7 7 5 6 8 6 8 4 4 6 6 8 8 8 8 8 8 5 5 5 4 8 8 8 8 5 5 5 9 7 9 5</div><div class='input'><span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='va'>new</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span>, <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt;  [1] 14 14 10 12 16 12 16  8  8 12 12 16 16 16 16 16 16 10 10 10  8 16 16 16 16
#&gt; [26] 10 10 10 18 14 18 10</div><div class='input'>

<span class='co'># In some cases your data mask is a whole chain of environments</span>
<span class='co'># rather than a single environment. You'll have to use</span>
<span class='co'># `new_data_mask()` and let it know about the bottom of the mask</span>
<span class='co'># (the last child of the environment chain) and the topmost parent.</span>

<span class='co'># A common situation where you'll want a multiple-environment mask</span>
<span class='co'># is when you include functions in your mask. In that case you'll</span>
<span class='co'># put functions in the top environment and data in the bottom. This</span>
<span class='co'># will prevent the data from overwriting the functions.</span>
<span class='va'>top</span> <span class='op'>&lt;-</span> <span class='fu'><a href='env.html'>new_environment</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>`+` <span class='op'>=</span> <span class='fu'>base</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span>, c <span class='op'>=</span> <span class='fu'>base</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># Let's add a middle environment just for sport:</span>
<span class='va'>middle</span> <span class='op'>&lt;-</span> <span class='fu'><a href='env.html'>env</a></span><span class='op'>(</span><span class='va'>top</span><span class='op'>)</span>

<span class='co'># And finally the bottom environment containing data:</span>
<span class='va'>bottom</span> <span class='op'>&lt;-</span> <span class='fu'><a href='env.html'>env</a></span><span class='op'>(</span><span class='va'>middle</span>, a <span class='op'>=</span> <span class='st'>"a"</span>, b <span class='op'>=</span> <span class='st'>"b"</span>, c <span class='op'>=</span> <span class='st'>"c"</span><span class='op'>)</span>

<span class='co'># We can now create a mask by supplying the top and bottom</span>
<span class='co'># environments:</span>
<span class='va'>mask</span> <span class='op'>&lt;-</span> <span class='fu'>new_data_mask</span><span class='op'>(</span><span class='va'>bottom</span>, top <span class='op'>=</span> <span class='va'>top</span><span class='op'>)</span>

<span class='co'># This data mask can be passed to eval_tidy() instead of a list or</span>
<span class='co'># data frame:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='va'>a</span> <span class='op'>+</span> <span class='va'>b</span> <span class='op'>+</span> <span class='va'>c</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "a b c"</div><div class='input'>
<span class='co'># Note how the function `c()` and the object `c` are looked up</span>
<span class='co'># properly because of the multi-level structure:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>a</span>, <span class='va'>b</span>, <span class='va'>c</span><span class='op'>)</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "a b c"</div><div class='input'>
<span class='co'># new_data_mask() does not create data pronouns, but</span>
<span class='co'># data pronouns can be added manually:</span>
<span class='va'>mask</span><span class='op'>$</span><span class='va'>.fns</span> <span class='op'>&lt;-</span> <span class='fu'>as_data_pronoun</span><span class='op'>(</span><span class='va'>top</span><span class='op'>)</span>

<span class='co'># The `.data` pronoun should generally be created from the</span>
<span class='co'># mask. This will ensure data is looked up throughout the whole</span>
<span class='co'># ancestry. Only non-function objects are looked up from this</span>
<span class='co'># pronoun:</span>
<span class='va'>mask</span><span class='op'>$</span><span class='va'>.data</span> <span class='op'>&lt;-</span> <span class='fu'>as_data_pronoun</span><span class='op'>(</span><span class='va'>mask</span><span class='op'>)</span>
<span class='va'>mask</span><span class='op'>$</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>c</span>
</div><div class='output co'>#&gt; [1] "c"</div><div class='input'>
<span class='co'># Now we can reference the values with the pronouns:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>a</span>, <span class='va'>.data</span><span class='op'>$</span><span class='va'>b</span>, <span class='va'>.data</span><span class='op'>$</span><span class='va'>c</span><span class='op'>)</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>mask</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "a b c"</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Lionel Henry, <a href='http://hadley.nz'>Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


